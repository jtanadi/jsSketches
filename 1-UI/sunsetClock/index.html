<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clock</title>

  <style>
    * {
      margin: 0 1em;
    }

    .wrapper {
      width: auto;
      height: 100vh;
      display: flex;
    }

    p {
      flex-shrink: 1;
      margin: auto;
      font-size: 10em;
      font-family: Arial, Helvetica, sans-serif;
      border-bottom: 25px solid white;
    }

    .day {
      border-bottom: 25px solid yellow;
    }

    .sunset {
      border-bottom: 25px solid magenta;
    }
    
    .evening {
      border-bottom: 25px solid cyan;
    }
  
  </style>
</head>
<body>
  <div class="wrapper">
    <p id="clock">
      HH : MM : SS
    </p>
  </div>

  <script>
    let sunriseTime;
    let sunsetTime;
    let twilightEnd;
    const clock = document.getElementById("clock");

    const getTodaysDate = () => {
      const timeNow = new Date(Date.now());
      const year = timeNow.getFullYear();
      const month = timeNow.getMonth() + 1; // month starts at 0
      const date = timeNow.getDate();
      return `${year}-${month}-${date}`;
    }

    const checkSun = (sunrise, sunset, twilightEnd) => {
      const timeNow = Date.now();

      if(timeNow >= sunrise && timeNow < sunset) {
        clock.classList = ["day"];
      } else if(timeNow >= sunset && timeNow <= twilightEnd) {
        clock.classList = ["sunset"];
      } else {
        clock.classList = ["evening"];
      }
    }

    const makeAjaxPromise = (url) => {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", url);
        xhr.send();
        xhr.onreadystatechange = () => {
          if(xhr.readyState === 4){
            (xhr.status === 200)
              ? resolve(JSON.parse(xhr.responseText))
              : reject(`ready state: ${xhr.readyState}, status: ${xhr.status}`);
          }
        } // end onreadystatechange
      }); // end returned Promise
    }; // end makeAjaxPromise
    
    makeAjaxPromise("http://geoip.nekudo.com/api/")
      .then(response => {
        const loc = response.location
        return makeAjaxPromise(`https://api.sunrise-sunset.org/json?lat=${loc.latitude}&lng=${loc.longitude}&date=${getTodaysDate()}&formatted=0`)
      })
      .then(data => {
        sunriseTime = new Date(data.results.sunrise).getTime();
        sunsetTime = new Date(data.results.sunset).getTime();
        twilightEnd = new Date(data.results.civil_twilight_end).getTime();
        console.log(`sunrise: ${sunriseTime}, sunset: ${sunsetTime}, twilight end: ${twilightEnd}`)
        checkSun(sunriseTime, sunsetTime, twilightEnd)
      })

    const updateClock = () => {
      let amPM;
      const convertHour = num => {
        if(num == 0) {
          amPM = "AM";
          return 12;
        } else if (num > 0 && num < 12) {
          amPM = "AM";
          return num;
        } else if (num == 12) {
          amPM = "PM"
          return num
        } else if (num > 12) {
          amPM = "PM"
          return num - 12
        }
      }

      const zFill = num => {
        return (num < 10) ? `0${num}` : `${num}`
      }

      const timeNow = new Date(Date.now());

      const hour = zFill(convertHour(timeNow.getHours()));
      const minute = zFill(timeNow.getMinutes());
      const seconds = zFill(timeNow.getSeconds());
      
      // Sunset is checked every 10 seconds... performance concern?
      if(seconds.endsWith("0")) checkSun(sunriseTime, sunsetTime, twilightEnd);
      clock.innerHTML = `${hour} : ${minute} : ${seconds} ${amPM}`
    }
    updateClock();
    window.setInterval(updateClock, 1000);
  </script>

</body>
</html>